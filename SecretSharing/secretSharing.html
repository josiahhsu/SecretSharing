<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Sharing Demo</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="secretSharing.js"></script>
</head>
<body>
    <h2>Secret Sharing Demo</h2> 
    <p>
        This is a demo of secret sharing, which is a security scheme where a message is split into <i>n</i> 
        shares. These shares are then sent to a recipient, who can reconstruct the original message by 
        recombining the <i>n</i> shares. Without all <i>n</i> shares, the original message cannot be
        recovered. As the name implies, this scheme can be used to enhance secrecy when transmitting messages.
    </p>

    <p>
        In this example, the splitting and reconstruction algorithms use a simple XOR scheme. For splitting, the plaintext is 
        encoded as an array of charcodes, which is then XORed with random pads to create <i>n</i>-1 shares. The <i>n</i>th
        share is then generated by XORing all the other shares together. Recombination simply XORs these shares together to get
        the original array of charcodes, which is then decoded to reconstruct the original message. More sophisticated secret 
        sharing schemes use methods like interpolation for splitting and reconstructing shares.
    </p>

    <p>
        This demo lets you start by choosing what value of <i>n</i> to use. You can then either enter a message to be split or
        enter shares to be reconstructed. Click "Split" to split the message into <i>n</i> shares, and click "Combine" to combine
        the <i>n</i> shares into the message.
    </p>

    <script>
        function get_n()
        {
            return document.getElementById("n").value;
        }

        function copy_text(id)
        {
            let copyText = document.getElementById(id);
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
        }

        function clear_text(id)
        {
            document.getElementById(id).value = "";
            update_charcodes();
        }

        function clear_shares()
        {
            if (!confirm("Clear all shares?"))
                return;

            let n = get_n();
            for (var i = 0; i < n; i++)
                clear_text(`share${i+1}`);
        }

        function update_shares()
        {
            let n = get_n();
            let table = document.getElementById("shares");
            table.innerHTML = "";

            for (var i = 0; i < n; i++)
            {
                table.innerHTML += `<tr><td><textarea id="share${i+1}" placeholder="Share ${i+1}"></textarea></td></tr>`;
                table.innerHTML += `<button onclick="copy_text('share${i+1}')">Copy</button>`;
                table.innerHTML += `<button onclick="clear_text('share${i+1}')">Clear</button><br><br>`;
            }
        }

        function update_charcodes()
        {
            let text = document.getElementById("plaintext").value;
            document.getElementById("plaintext_charcodes").value = array_to_hexstring(get_charcode_array(text));
        }

        function split_message()
        {
            let n = get_n();
            let shares = split_plaintext(document.getElementById("plaintext").value, n);
            for (var i = 0; i < n; i++)
            {
                document.getElementById("share"+(i+1)).value = array_to_hexstring(shares[i]);
            }
        }

        function combine_message()
        {
            let n = get_n();
            let shares = [];
            let invalids = []
            for (var i = 0; i < n; i++)
            {
                let share_text = document.getElementById("share"+(i+1)).value;
                if (share_text)
                {
                    share = hexstring_to_array(share_text);
                    if (share.includes(NaN))
                        invalids.push(i+1);
                    else
                        shares.push(share);
                }
            }

            let c = invalids.length;
            if (c > 0)
            {
                display_error(`Invalid characters found in share${c > 1? "s" : ""} ${invalids}`);
                return;
            }

            if (shares.length != n)
            {
                display_error(`${n} shares expected, but ${shares.length} shares found.`);
                return;
            }

            document.getElementById("plaintext").value = combine_shares(shares);
            update_charcodes();
        }
    </script>

    <b>Number of shares:</b>
    <select id="n" onchange="update_shares()">
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5" selected="selected">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
    </select><br><br>

    <div>
        <b>Message:</b>
        <textarea id="plaintext" onchange="update_charcodes()"placeholder="Type your message here."></textarea><br>
        <button onclick="split_message()">Split</button>
        <button onclick="clear_text(`plaintext`)">Clear</button><br><br>
        <b>Charcode representation of message:</b>
        <textarea id="plaintext_charcodes" readonly="true" placeholder="None"></textarea><br><br>
        
    </div>

    <div id="shares_div">
        <b>Shares:</b>
        <table id="shares" style="width:100%""></table>
        <script>update_shares()</script>
        
        <button onclick="combine_message()">Combine</button>
        <button onclick="clear_shares()">Clear All Shares</button>
    </div>
</body>
