<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Sharing Demo</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" type="image/x-icon" href="../Birb-icon.png">
    <script src="secretSharing.js"></script>
</head>
<body>
    <h2>Secret Sharing Demo</h2> 
    <p>
        This is a demo of secret sharing, which is a security scheme where a message is protected by being split into shares.
        In this scheme, <i>n</i> shares are generated such that no individual share reveals any information about the original message.
        Once these <i>n</i> shares are generated, the message can only be reconstructed if <i>k</i> shares are used, where <i>k</i> is less than or equal to <i>n</i>.
        This is known as the (<i>k, n</i>) threshold scheme, where <i>k</i> is the threshold for reconstruction and <i>n</i> is the number of shares actually generated.
        Secret sharing in this form is credited to Adi Shamir and George Robert Blakley, both of whom developed this scheme independently.
    </p>

    <p>
        In this example, the splitting and reconstruction algorithms use a simple XOR scheme.
        For splitting, the message is first encoded as an array of charcodes using UTF-8 encoding.
        <i>n</i>-1 shares are then generated by creating random pads the same length as this array.
        The <i>n</i>th share is then generated by XORing the original charcode array with all the other randomly generated shares. 
        Recombination simply XORs the <i>n</i> shares together to get the original array of UTF-8 charcodes, which is then decoded to reconstruct the original message.
        The mechanics of the XOR scheme dictate that the number of shares needed for reconstruction is exactly equal to the number of shares generated, meaning <i>k = n</i>.
        More sophisticated secret sharing schemes use methods like interpolation for splitting and reconstructing shares, which allows <i>k</i> to be less than <i>n</i>.
    </p>

    <p>
        This demo lets you choose any value of <i>n</i> from 2 to 9.
        You can then either enter a message to be split or enter shares to be reconstructed.
        Click "Split" to split the message into <i>n</i> shares, and click "Combine" to combine the <i>n</i> shares into the message.
        Shares and original charcodes are all represented as a sequence of hexadecimal byte values.
        The delimiter used for these sequences can be changed if desired. 
    </p>

    <script>
        function get_n()
        {
            let n = document.getElementById("n");
            if (n.value < 2)
                n.value = 2;
            else if (n.value > 9)
                n.value = 9;
            return n.value;
        }

        function get_delim(old=false)
        {
            let delim = document.getElementById("delim");
            return old? delim.oldvalue : delim.value;
        }

        function update_value(id)
        {
            id.oldvalue = id.value;
        }

        function update_format()
        {
            update_charcodes();
            for (var i = 0; i < get_n(); i++)
            {
                let share = document.getElementById("share"+(i+1));
                if (share.value)
                    share.value = array_to_hexstring(hexstring_to_array(share.value, get_delim(true)), get_delim());
            }
        }

        function trim_text(id)
        {
            id.value = id.value.trim();
        }

        function copy_text(id)
        {
            let copyText = document.getElementById(id);
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
        }

        function clear_text(id)
        {
            document.getElementById(id).value = "";
            update_charcodes();
        }

        function clear_shares()
        {
            if (!confirm("Clear all shares?"))
                return;

            let n = get_n();
            for (var i = 0; i < n; i++)
                clear_text(`share${i+1}`);
        }

        function update_shares()
        {
            let n = get_n();
            let table = document.getElementById("shares");
            table.innerHTML = "";

            for (var i = 0; i < n; i++)
            {
                table.innerHTML += `<tr><td><textarea id="share${i+1}" placeholder="Share ${i+1}" onchange="trim_text(share${i+1})"></textarea></td></tr>`;
                table.innerHTML += `<button onclick="copy_text('share${i+1}')">Copy</button>`;
                table.innerHTML += `<button onclick="clear_text('share${i+1}')">Clear</button><br><br>`;
            }
        }

        function update_charcodes()
        {
            let text = document.getElementById("plaintext");
            trim_text(text);
            document.getElementById("plaintext_charcodes").value = array_to_hexstring(get_charcode_array(text.value), get_delim());
        }

        function split_message()
        {
            let n = get_n();
            let shares = split_plaintext(document.getElementById("plaintext").value, n);
            for (var i = 0; i < n; i++)
            {
                document.getElementById("share"+(i+1)).value = array_to_hexstring(shares[i], get_delim());
            }
        }

        function combine_message()
        {
            let n = get_n();
            let shares = [];
            let invalids = []
            for (var i = 0; i < n; i++)
            {
                let share_text = document.getElementById("share"+(i+1)).value;
                if (share_text)
                {
                    share = hexstring_to_array(share_text, get_delim());
                    if (share.includes(NaN))
                        invalids.push(i+1);
                    else
                        shares.push(share);
                }
            }

            let c = invalids.length;
            if (c > 0)
            {
                display_error(`Invalid hex values found in share${c > 1? "s" : ""} ${invalids}`);
                return;
            }

            if (shares.length != n)
            {
                display_error(`${n} shares expected, but ${shares.length} shares found.`);
                return;
            }

            document.getElementById("plaintext").value = combine_shares(shares);
            update_charcodes();
        }
    </script>

    <b>Number of shares:</b>
    <input type="number" id="n" value=5 min=2 max=9 style="width: 2em" onchange="update_shares()"></input>
    <br>
    <b>Hexstring delimiter:</b>
    <select id="delim" onfocus="update_value(this)" onchange="update_format(); update_value(this)">
        <option value=" " selected="selected">Spaces</option>
        <option value=",">Commas</option>
        <option value="|">Pipes</option>
        <option value="">None</option>
    </select><br><br>

    <div>
        <b>Message:</b>
        <textarea id="plaintext" onchange="update_charcodes()"placeholder="Type your message here."></textarea><br>
        <button onclick="split_message()">Split</button>
        <button onclick="clear_text(`plaintext`)">Clear</button><br><br>
        <b>Charcode representation of message:</b>
        <textarea id="plaintext_charcodes" readonly="true" placeholder="None"></textarea><br><br>
        
    </div>

    <div id="shares_div">
        <b>Shares:</b>
        <table id="shares" style="width:100%""></table>
        <script>update_shares()</script>
        
        <button onclick="combine_message()">Combine</button>
        <button onclick="clear_shares()">Clear All Shares</button>
    </div>
</body>
